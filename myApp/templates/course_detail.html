{% extends 'base.html' %}
{% load static %}

{% block title %}{{ course.name }} - Swedish Wealth Institute{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Course Header -->
    <div class="mb-8">
        <h1 class="text-4xl md:text-5xl font-semibold mb-4 text-gray-800">{{ course.name }}</h1>
        <p class="text-xl text-gray-700 max-w-3xl">{{ course.short_description }}</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
        <!-- Main Content (2 columns) -->
        <div class="lg:col-span-2 space-y-8">
            <!-- Preview Video or Thumbnail -->
            {% if preview_video_embed_url %}
            <div class="bg-[#ffffff]/60 backdrop-blur-sm border border-teal-soft/10 rounded-xl overflow-hidden shadow-lg">
                <div class="aspect-video bg-gray-900 relative">
                    {% if is_youtube %}
                    <iframe 
                        id="youtube-preview" 
                        class="w-full h-full" 
                        src="{{ preview_video_embed_url }}" 
                        title="YouTube video player" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" 
                        referrerpolicy="strict-origin-when-cross-origin"
                        allowfullscreen>
                    </iframe>
                    <div id="youtube-error" class="hidden absolute inset-0 flex items-center justify-center bg-gray-900 text-white p-4">
                        <div class="text-center">
                            <p class="text-lg font-semibold mb-2">Video cannot be embedded</p>
                            <p class="text-sm text-black mb-4">Please check that the video allows embedding in its privacy settings.</p>
                            <a href="{{ course.preview_video_url }}" target="_blank" class="text-teal-soft hover:text-teal-400 underline">Watch on YouTube</a>
                        </div>
                    </div>
                    {% elif is_vimeo or is_google_drive %}
                    <iframe class="w-full h-full" src="{{ preview_video_embed_url }}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    {% elif is_cloudinary or is_direct %}
                    <video class="w-full h-full" controls>
                        <source src="{{ preview_video_embed_url }}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                    {% else %}
                    <iframe class="w-full h-full" src="{{ preview_video_embed_url }}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
                    {% endif %}
                </div>
            </div>
            {% elif course.thumbnail %}
            <div class="bg-[#ffffff]/60 backdrop-blur-sm border border-teal-soft/10 rounded-xl overflow-hidden shadow-lg">
                <img src="{{ course.thumbnail.url }}" alt="{{ course.name }}" class="w-full h-auto object-cover">
            </div>
            {% endif %}

            <!-- Course Description -->
            <div class="bg-[#ffffff]/60 backdrop-blur-sm border border-teal-soft/10 rounded-xl p-8">
                <h2 class="text-2xl font-bold mb-4 text-black text-gray-800">About This Course</h2>
                <div class="prose prose-gray max-w-none">
                    <p class="text-gray-700 leading-relaxed whitespace-pre-line">{{ course.description }}</p>
                </div>
            </div>

            <!-- Course Curriculum -->
            {% if course.modules.exists or course.lessons.exists %}
            <div class="bg-[#ffffff]/60 backdrop-blur-sm border border-teal-soft/10 rounded-xl p-8">
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Course Curriculum</h2>
                
                {% if course.modules.exists %}
                    {% for module in course.modules.all %}
                    <div class="mb-6 last:mb-0">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3 flex items-center gap-2">
                            <i class="fas fa-folder-open text-teal-soft"></i>
                            {{ module.name }}
                        </h3>
                        {% if module.description %}
                        <p class="text-sm text-black text-gray-600 mb-3 ml-7">{{ module.description }}</p>
                        {% endif %}
                        
                        <div class="space-y-2 ml-7">
                            {% for lesson in module.lessons.all %}
                            <div class="flex items-start gap-3 p-3 rounded-lg hover:bg-gray-50 transition">
                                <i class="fas fa-play-circle text-teal-soft mt-1"></i>
                                <div class="flex-1">
                                    <div class="font-medium text-gray-800">{{ lesson.title }}</div>
                                    {% if lesson.video_duration %}
                                    <div class="text-xs text-gray-600 mt-1">
                                        <i class="fas fa-clock mr-1"></i>{{ lesson.video_duration }} min
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <!-- Lessons without modules -->
                    <div class="space-y-2">
                        {% for lesson in course.lessons.all %}
                        <div class="flex items-start gap-3 p-3 rounded-lg hover:bg-gray-50 transition">
                            <i class="fas fa-play-circle text-teal-soft mt-1"></i>
                            <div class="flex-1">
                                <div class="font-medium text-gray-800">{{ lesson.title }}</div>
                                {% if lesson.video_duration %}
                                <div class="text-xs text-gray-600 mt-1">
                                    <i class="fas fa-clock mr-1"></i>{{ lesson.video_duration }} min
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                {% endif %}

                <div class="mt-6 pt-6 border-t border-gray-200 flex items-center gap-4 text-sm text-black text-gray-600">
                    <span><i class="fas fa-video mr-2"></i>{{ course.get_lesson_count }} lessons</span>
                    {% if course.modules.exists %}
                    <span><i class="fas fa-folder mr-2"></i>{{ course.modules.count }} modules</span>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar (1 column) -->
        <div class="lg:col-span-1">
            <div class="bg-[#ffffff]/60 backdrop-blur-sm border border-teal-soft/10 rounded-xl p-8 sticky top-8">
                {% if show_purchase %}
                <!-- Purchase Section -->
                <div class="text-center">
                    <div class="mb-6">
                        <h2 class="text-2xl font-bold mb-2 text-gray-800">Get Lifetime Access</h2>
                        <p class="text-3xl font-bold text-teal-soft mb-4">
                            {{ course.price|floatformat:2 }} {{ course.currency }}
                        </p>
                        <p class="text-sm text-black text-gray-700 mb-6">One-time payment â€¢ Lifetime access to all lessons, quizzes, and certificates</p>
                    </div>
                    
                    {% if user.is_authenticated %}
                    <button id="purchase-btn" class="w-full px-8 py-4 bg-teal-soft text-white rounded-full font-bold hover:bg-teal-soft/90 transition-all text-lg mb-3">
                        <i class="fas fa-shopping-cart mr-2"></i> Buy Course Now
                    </button>
                    <a href="{% url 'gift_course' course.slug %}" class="block w-full px-8 py-4 bg-white border-2 border-teal-soft text-teal-soft rounded-full font-bold hover:bg-teal-soft/10 transition-all text-lg mb-4 text-center">
                        <i class="fas fa-gift mr-2"></i> Gift This Course
                    </a>
                    <p class="text-xs text-gray-600">
                        <i class="fas fa-lock mr-1"></i> Secure payment processing
                    </p>
                    {% else %}
                    <a href="{% url 'login' %}?next={% url 'course_detail' course.slug %}" class="block w-full px-8 py-4 bg-teal-soft text-white rounded-full font-bold hover:bg-teal-soft/90 transition-all text-lg mb-3 text-center">
                        <i class="fas fa-sign-in-alt mr-2"></i> Login to Purchase
                    </a>
                    <a href="{% url 'login' %}?next={% url 'gift_course' course.slug %}" class="block w-full px-8 py-4 bg-white border-2 border-teal-soft text-teal-soft rounded-full font-bold hover:bg-teal-soft/10 transition-all text-lg mb-4 text-center">
                        <i class="fas fa-gift mr-2"></i> Gift This Course
                    </a>
                    {% endif %}
                </div>

                <!-- Course Features -->
                <div class="mt-8 pt-8 border-t border-gray-200">
                    <h3 class="font-semibold text-gray-800 mb-4">What's Included</h3>
                    <ul class="space-y-3 text-sm text-black text-gray-700">
                        <li class="flex items-start gap-2">
                            <i class="fas fa-check-circle text-teal-soft mt-0.5"></i>
                            <span>{{ course.get_lesson_count }} video lessons</span>
                        </li>
                        {% if course.modules.exists %}
                        <li class="flex items-start gap-2">
                            <i class="fas fa-check-circle text-teal-soft mt-0.5"></i>
                            <span>{{ course.modules.count }} learning modules</span>
                        </li>
                        {% endif %}
                        <li class="flex items-start gap-2">
                            <i class="fas fa-check-circle text-teal-soft mt-0.5"></i>
                            <span>Lifetime access</span>
                        </li>
                        {% if course.is_accredible_certified %}
                        <li class="flex items-start gap-2">
                            <i class="fas fa-check-circle text-teal-soft mt-0.5"></i>
                            <span>Accredited certificate</span>
                        </li>
                        {% endif %}
                        <li class="flex items-start gap-2">
                            <i class="fas fa-check-circle text-teal-soft mt-0.5"></i>
                            <span>Downloadable resources</span>
                        </li>
                    </ul>
                </div>
                {% else %}
                <!-- Free Course / No Purchase Needed -->
                <div class="text-center">
                    <i class="fas fa-book-open text-6xl text-gray-600 mb-4"></i>
                    <p class="text-gray-700 mb-6">
                        {% if course.lessons.exists %}
                        This course is available. 
                        {% if user.is_authenticated %}
                        <a href="{% url 'lesson_detail' course.slug course.lessons.first.slug %}" class="text-teal-soft hover:text-teal-800 font-semibold">Start learning now!</a>
                        {% else %}
                        <a href="{% url 'login' %}?next={% url 'course_detail' course.slug %}" class="text-teal-soft hover:text-teal-800 font-semibold">Login to access</a>
                        {% endif %}
                        {% else %}
                        This course doesn't have any lessons yet.
                        {% endif %}
                    </p>
                    <a href="{% url 'courses' %}" class="inline-block px-6 py-3 bg-teal-soft text-white rounded-full font-bold hover:bg-teal-soft/90 transition-all">
                        Back to Courses
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% if is_youtube %}
<script>
// Detect YouTube embed errors
document.addEventListener('DOMContentLoaded', function() {
    const iframe = document.getElementById('youtube-preview');
    if (iframe) {
        // Check if iframe loaded successfully after a delay
        setTimeout(function() {
            try {
                // Try to access iframe content (will fail if error occurred)
                iframe.contentWindow;
            } catch (e) {
                // Cross-origin error is normal, but if we can't access it at all, might be an issue
                console.log('YouTube iframe loaded');
            }
        }, 2000);
        
        // Listen for iframe load errors (limited browser support)
        iframe.addEventListener('error', function() {
            document.getElementById('youtube-error').classList.remove('hidden');
        });
    }
});
</script>
{% endif %}

{% if show_purchase and user.is_authenticated %}
<script>
document.getElementById('purchase-btn').addEventListener('click', function() {
    const btn = this;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
    
    fetch('{% url "initiate_purchase" course.slug %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.status === 'paid') {
                // Payment was simulated/approved - redirect to course
                if (data.redirect) {
                    window.location.href = data.redirect;
                } else {
                    // Show success message and reload page
                    alert('Purchase successful! Access granted.');
                    window.location.reload();
                }
            } else {
                // Payment pending - would redirect to payment provider in production
                alert('Purchase initiated! Redirecting to payment provider...');
                // TODO: Integrate with your payment provider
                // For example: window.location.href = paymentProviderUrl;
                console.log('Purchase ID:', data.purchase_id);
            }
        } else {
            alert('Error: ' + (data.error || 'Failed to initiate purchase'));
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-shopping-cart mr-2"></i> Buy Course Now';
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred. Please try again.');
        btn.disabled = false;
        btn.innerHTML = '<i class="fas fa-shopping-cart mr-2"></i> Buy Course Now';
    });
});
</script>
{% endif %}
{% endblock %}
