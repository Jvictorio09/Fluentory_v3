{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Students & Activity - Admin Dashboard{% endblock %}
{% block page_title %}Students & Activity Feed{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Filters and Search -->
    <div class="bg-[#ffffff]/60 backdrop-blur-sm border border-teal-soft/10 rounded-xl p-6">
        <form method="get" class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- Search -->
            <div>
                <label class="block text-sm font-medium mb-2">Search Students</label>
                <input type="text" name="search" value="{{ search_query }}" placeholder="Name, email..." 
                    class="w-full bg-[#ffffff]/60 border border-teal-soft/20 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-teal-soft/50">
            </div>
            
            <!-- Course Filter -->
            <div>
                <label class="block text-sm font-medium mb-2">Filter by Course</label>
                <select name="course" class="w-full bg-[#ffffff]/60 border border-teal-soft/20 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-teal-soft/50">
                    <option value="">All Courses</option>
                    {% for course in courses %}
                    <option value="{{ course.id }}" {% if course_filter == course.id|stringformat:"s" %}selected{% endif %}>{{ course.name }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <!-- Status Filter -->
            <div>
                <label class="block text-sm font-medium mb-2">Status</label>
                <select name="status" class="w-full bg-[#ffffff]/60 border border-teal-soft/20 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-teal-soft/50">
                    <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All Students</option>
                    <option value="active" {% if status_filter == 'active' %}selected{% endif %}>Active</option>
                    <option value="completed" {% if status_filter == 'completed' %}selected{% endif %}>Completed</option>
                    <option value="certified" {% if status_filter == 'certified' %}selected{% endif %}>Certified</option>
                </select>
            </div>
            
            <!-- Sort -->
            <div>
                <label class="block text-sm font-medium mb-2">Sort By</label>
                <select name="sort" class="w-full bg-[#ffffff]/60 border border-teal-soft/20 rounded-lg px-4 py-2 text-sm focus:outline-none focus:border-teal-soft/50">
                    <option value="recent" {% if sort_by == 'recent' %}selected{% endif %}>Most Recent Activity</option>
                    <option value="progress" {% if sort_by == 'progress' %}selected{% endif %}>Progress %</option>
                    <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Name (A-Z)</option>
                    <option value="enrolled" {% if sort_by == 'enrolled' %}selected{% endif %}>Recently Enrolled</option>
                </select>
            </div>
            
            <div class="flex items-end">
                <button type="submit" class="w-full px-4 py-2 bg-gradient-to-r from-teal-soft to-blue-soft hover:from-teal-soft/90 hover:to-blue-soft/90 text-[#ffffff] font-semibold text-gray-700 rounded-lg transition-all">
                    <i class="fas fa-filter mr-2"></i>Apply Filters
                </button>
            </div>
        </form>
    </div>

    <!-- Two Column Layout -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Students List -->
        <div class="lg:col-span-2 space-y-4">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-bold">Students ({{ students_data|length }})</h2>
                <a href="{% url 'dashboard_student_progress' %}" class="text-sm text-teal-soft hover:text-teal-soft/80">
                    Detailed View <i class="fas fa-arrow-right ml-1"></i>
                </a>
            </div>
            
            {% if students_data %}
            <div class="space-y-3">
                {% for data in students_data %}
                <div class="bg-[#ffffff]/60 backdrop-blur-sm border border-teal-soft/10 rounded-xl p-4 hover:border-teal-soft/30 transition-all">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-start gap-4 flex-1">
                            <!-- Avatar -->
                            <div class="w-12 h-12 rounded-full bg-gradient-to-br from-teal-soft to-blue-soft flex items-center justify-center text-[#ffffff] font-bold">
                                {{ data.student.username|first|upper }}
                            </div>
                            
                            <!-- Student Info -->
                            <div class="flex-1">
                                <div class="flex items-center gap-3 mb-1">
                                    <h3 class="font-bold text-lg">{{ data.student.get_full_name|default:data.student.username }}</h3>
                                    <span class="px-2 py-1 rounded-full text-xs font-semibold text-gray-700
                                        {% if data.status == 'certified' %}bg-yellow-500/20 text-yellow-300 border border-yellow-500/30
                                        {% elif data.status == 'completed' %}bg-green-500/20 text-green-400 border border-green-500/30
                                        {% elif data.status == 'active' %}bg-teal-soft/20 text-teal-soft border border-teal-soft/30
                                        {% else %}bg-gray-500/20 text-gray-700 border border-gray-500/30{% endif %}">
                                        {{ data.status|title }}
                                    </span>
                                </div>
                                <p class="text-sm text-gray-700 mb-2">{{ data.student.email }}</p>
                                
                                <!-- Progress Bar -->
                                <div class="mb-2">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="text-xs text-gray-700">Overall Progress</span>
                                        <span class="text-xs font-semibold text-gray-700 text-teal-soft">{{ data.overall_progress }}%</span>
                                    </div>
                                    <div class="w-full bg-[#f8fafc] rounded-full h-2 overflow-hidden">
                                        <div class="h-full bg-gradient-to-r from-teal-soft to-blue-soft transition-all" style="width: {{ data.overall_progress }}%"></div>
                                    </div>
                                </div>
                                
                                <!-- Stats -->
                                <div class="flex items-center gap-4 text-xs text-gray-700">
                                    <span><i class="fas fa-book mr-1"></i>{{ data.total_courses }} Courses</span>
                                    <span><i class="fas fa-check-circle mr-1"></i>{{ data.completed_lessons }}/{{ data.total_lessons }} Lessons</span>
                                    {% if data.certifications_count > 0 %}
                                    <span><i class="fas fa-certificate mr-1 text-yellow-400"></i>{{ data.certifications_count }} Certified</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <!-- Recent Activity Indicator -->
                        {% if data.recent_activity %}
                        <div class="flex flex-col items-end gap-2">
                            <div class="text-xs text-gray-700">
                                {% if data.recent_activity.0 == 'progress' %}
                                <i class="fas fa-video text-teal-soft"></i>
                                {% elif data.recent_activity.0 == 'exam' %}
                                <i class="fas fa-clipboard-check text-blue-soft"></i>
                                {% elif data.recent_activity.0 == 'cert' %}
                                <i class="fas fa-certificate text-yellow-400"></i>
                                {% endif %}
                            </div>
                            <div class="text-xs text-gray-500">{{ data.recent_activity.1|timesince }} ago</div>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex items-center gap-2 pt-3 border-t border-teal-soft/10">
                        <a href="{% url 'dashboard_student_detail' data.student.id %}" class="flex-1 px-3 py-2 bg-teal-soft/10 hover:bg-teal-soft/20 border border-teal-soft/20 rounded-lg text-sm font-medium text-center transition-all">
                            View Details
                        </a>
                        <a href="mailto:{{ data.student.email }}" class="px-3 py-2 bg-blue-soft/10 hover:bg-blue-soft/20 border border-blue-soft/20 rounded-lg text-sm transition-all">
                            <i class="fas fa-envelope"></i>
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="bg-[#ffffff]/60 backdrop-blur-sm border border-teal-soft/10 rounded-xl p-12 text-center">
                <i class="fas fa-users text-6xl text-gray-600 mb-4"></i>
                <h3 class="text-xl font-semibold text-gray-700 mb-2">No Students Found</h3>
                <p class="text-gray-700">Try adjusting your filters</p>
            </div>
            {% endif %}
        </div>
        
        <!-- Activity Feed -->
        <div class="space-y-4">
            <div class="flex items-center justify-between">
                <h2 class="text-xl font-bold">Activity Feed</h2>
                <button onclick="refreshActivity()" class="text-sm text-teal-soft hover:text-teal-soft/80">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            
            <div class="bg-[#ffffff]/60 backdrop-blur-sm border border-teal-soft/10 rounded-xl p-4 max-h-[800px] overflow-y-auto" id="activity-feed">
                {% if activity_feed %}
                <div class="space-y-4">
                    {% for activity in activity_feed %}
                    <div class="border-l-2 border-teal-soft/30 pl-4 pb-4 last:pb-0">
                        <div class="flex items-start gap-3">
                            <!-- Activity Icon -->
                            <div class="w-8 h-8 rounded-lg flex items-center justify-center flex-shrink-0
                                {% if activity.type == 'lesson_completed' %}bg-green-500/20 text-green-400
                                {% elif activity.type == 'exam_attempt' %}bg-blue-soft/20 text-blue-soft
                                {% elif activity.type == 'certification_issued' %}bg-yellow-500/20 text-yellow-400
                                {% else %}bg-teal-soft/20 text-teal-soft{% endif %}">
                                {% if activity.type == 'lesson_completed' %}
                                <i class="fas fa-check-circle text-sm"></i>
                                {% elif activity.type == 'exam_attempt' %}
                                <i class="fas fa-clipboard-check text-sm"></i>
                                {% elif activity.type == 'certification_issued' %}
                                <i class="fas fa-certificate text-sm"></i>
                                {% else %}
                                <i class="fas fa-chart-line text-sm"></i>
                                {% endif %}
                            </div>
                            
                            <!-- Activity Content -->
                            <div class="flex-1 min-w-0">
                                <div class="text-sm mb-1">
                                    <span class="font-semibold text-gray-700">{{ activity.user.get_full_name|default:activity.user.username }}</span>
                                    {% if activity.type == 'lesson_completed' %}
                                    completed <span class="font-medium text-teal-soft">{{ activity.lesson.title }}</span>
                                    {% elif activity.type == 'exam_attempt' %}
                                    {% if activity.data.passed %}
                                    <span class="text-green-400">passed</span> the exam for
                                    {% else %}
                                    <span class="text-red-400">attempted</span> the exam for
                                    {% endif %}
                                    <span class="font-medium text-teal-soft">{{ activity.course.name }}</span>
                                    {% elif activity.type == 'certification_issued' %}
                                    earned certification for <span class="font-medium text-yellow-400">{{ activity.course.name }}</span>
                                    {% else %}
                                    updated progress in <span class="font-medium text-teal-soft">{{ activity.lesson.title }}</span>
                                    {% endif %}
                                </div>
                                
                                <div class="text-xs text-gray-700 mb-2">
                                    <i class="fas fa-clock mr-1"></i>{{ activity.timestamp|timesince }} ago
                                </div>
                                
                                <!-- Additional Info -->
                                {% if activity.type == 'exam_attempt' and activity.data.score is not None %}
                                <div class="text-xs px-2 py-1 bg-blue-soft/10 border border-blue-soft/20 rounded inline-block">
                                    Score: {{ activity.data.score|floatformat:1 }}% (Attempt #{{ activity.data.attempt_number }})
                                </div>
                                {% elif activity.type == 'lesson_completed' %}
                                <div class="text-xs px-2 py-1 bg-green-500/10 border border-green-500/20 rounded inline-block">
                                    {{ activity.data.watch_percentage|floatformat:0 }}% watched
                                </div>
                                {% elif activity.type == 'progress_update' %}
                                <div class="text-xs px-2 py-1 bg-teal-soft/10 border border-teal-soft/20 rounded inline-block">
                                    {{ activity.data.watch_percentage|floatformat:0 }}% complete
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-8">
                    <i class="fas fa-inbox text-4xl text-gray-600 mb-3"></i>
                    <p class="text-gray-700 text-sm">No recent activity</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function refreshActivity() {
    window.location.reload();
}

// Auto-refresh activity feed every 30 seconds
setInterval(function() {
    // Only refresh if page is visible
    if (!document.hidden) {
        fetch(window.location.href)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newFeed = doc.getElementById('activity-feed');
                if (newFeed) {
                    document.getElementById('activity-feed').innerHTML = newFeed.innerHTML;
                }
            })
            .catch(err => console.log('Activity refresh failed:', err));
    }
}, 30000);
</script>
{% endblock %}



