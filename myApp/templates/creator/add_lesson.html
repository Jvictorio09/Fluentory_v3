{% extends 'base.html' %}
{% load static %}

{% block title %}Add Lesson - {{ course.name }}{% endblock %}

{% block content %}
<div class="w-full min-h-screen bg-slate-50 py-8">
    <div class="max-w-[1600px] mx-auto px-6">
        <!-- Header -->
        <div class="mb-8">
            <a href="{% url 'course_lessons' course.slug %}" class="text-teal-700 hover:text-teal-800 text-sm text-black mb-4 inline-flex items-center gap-2">
                <i class="fas fa-arrow-left"></i> Back to {{ course.name }}
            </a>
            <h1 class="text-4xl font-bold mb-2 text-slate-900">Add New Lesson</h1>
            <p class="text-gray-700">Upload your video and let AI organize everything</p>
        </div>

        <!-- Two-Column Layout -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Left Column: Main Form -->
            <div class="lg:col-span-2">
                <div class="bg-white border border-slate-200 rounded-2xl p-8 shadow-xl">
                    <form method="POST" id="lesson-form" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- STEP 1: Video Input (Optional) -->
                        <div class="mb-8" id="video-input-section">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-teal-soft to-blue-soft text-[#ffffff] flex items-center justify-center font-bold text-lg">1</div>
                                <h2 class="text-2xl font-bold text-slate-900">Video Input <span class="text-sm font-normal text-gray-500">(Optional)</span></h2>
                            </div>
                            
                            <div class="space-y-6" id="video-input-content">
                                <!-- Video File Upload -->
                                <div id="video-upload-section">
                                    <label class="block text-sm text-black font-semibold text-gray-700 mb-3 uppercase tracking-wider text-black/70">
                                        <i class="fas fa-upload mr-2"></i>Upload MP4 Video File
                                    </label>
                                    <div class="relative">
                                        <input 
                                            type="file" 
                                            name="video_file" 
                                            id="video-file"
                                            accept="video/mp4"
                                            class="hidden"
                                        >
                                        <label for="video-file" class="flex flex-col items-center justify-center w-full h-48 border-2 border-dashed border-teal-soft/30 rounded-xl bg-[#ffffff]/40 cursor-pointer hover:border-teal-soft/50 hover:bg-[#ffffff]/60 transition-all group">
                                            <div class="flex flex-col items-center justify-center pt-5 pb-6">
                                                <i class="fas fa-cloud-upload-alt text-5xl text-black/50 mb-4 group-hover:text-black transition-colors"></i>
                                                <p class="mb-2 text-sm text-black text-gray-700">
                                                    <span class="font-semibold text-gray-700 text-black">Click to upload</span> or drag and drop
                                                </p>
                                                <p class="text-xs text-gray-500">MP4 video file (MAX. 500MB)</p>
                                            </div>
                                        </label>
                                    </div>
                                    <p class="text-xs text-gray-700 mt-2">
                                        <i class="fas fa-info-circle mr-1"></i> Video will be automatically transcribed after upload. <span class="text-gray-500">(Optional - you can skip this step if your lesson doesn't have a video)</span>
                                    </p>
                                    <!-- Upload Progress -->
                                    <div id="upload-progress" class="hidden mt-4">
                                        <div class="flex items-center gap-3 mb-2">
                                            <div class="flex-1 bg-gray-700/30 rounded-full h-2 overflow-hidden">
                                                <div id="progress-bar" class="bg-gradient-to-r from-teal-soft to-blue-soft h-full rounded-full transition-all duration-300" style="width: 0%"></div>
                                            </div>
                                            <span id="progress-text" class="text-xs text-gray-700">0%</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- OR Divider -->
                                <div class="relative my-6" id="video-divider">
                                    <div class="absolute inset-0 flex items-center">
                                        <div class="w-full border-t border-teal-soft/10"></div>
                                    </div>
                                    <div class="relative flex justify-center text-sm text-black">
                                        <span class="px-4 bg-white text-slate-500 uppercase tracking-wider">OR</span>
                                    </div>
                                </div>
                                
                                <!-- Vimeo URL Input -->
                                <div id="vimeo-input-section">
                                    <label class="block text-sm text-black font-semibold text-gray-700 mb-3 uppercase tracking-wider text-black/70">
                                        <i class="fab fa-vimeo mr-2"></i>Paste Vimeo video link
                                    </label>
                                    <input 
                                        type="url" 
                                        name="vimeo_url" 
                                        id="vimeo-url"
                                        placeholder="https://vimeo.com/xxxxxxxxx"
                                        class="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm text-black text-slate-900 placeholder:text-slate-400 focus:outline-none focus:border-teal-500 focus:ring-4 focus:ring-teal-500/10 transition-all"
                                    >
                                    <p class="text-xs text-gray-700 mt-2">
                                        We'll automatically detect metadata, duration, and thumbnail. <span class="text-gray-500">(Optional)</span>
                                    </p>
                                </div>
                                
                                <!-- Skip Video Option -->
                                <div class="pt-4 border-t border-teal-soft/10" id="skip-video-section">
                                    <p class="text-sm text-gray-600 mb-3 text-center">
                                        Don't have a video for this lesson?
                                    </p>
                                    <button 
                                        type="button" 
                                        id="skip-video-btn"
                                        class="w-full px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-all text-sm font-medium cursor-pointer"
                                    >
                                        <i class="fas fa-forward mr-2"></i>Skip Video Step
                                    </button>
                                </div>
                                
                                <!-- Video Skipped Confirmation (hidden initially) -->
                                <div id="video-skipped-message" class="hidden pt-4 border-t border-teal-soft/10">
                                    <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                                        <div class="flex items-center gap-3">
                                            <i class="fas fa-check-circle text-green-600 text-xl"></i>
                                            <div>
                                                <p class="text-sm font-semibold text-green-900">Video Step Skipped</p>
                                                <p class="text-xs text-green-700 mt-1">You can proceed to add lesson content below. The form can be submitted without a video.</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Video Preview (hidden initially) -->
                                <div id="video-preview" class="hidden mt-4 p-5 bg-teal-soft/5 border border-teal-soft/20 rounded-xl">
                                    <div class="flex gap-4">
                                        <img id="preview-thumbnail" src="" alt="Video thumbnail" class="w-40 h-24 object-cover rounded-lg">
                                        <div class="flex-1">
                                            <div id="preview-title" class="font-semibold text-slate-900 mb-2"></div>
                                            <div class="text-sm text-black text-gray-700 mb-2">
                                                <i class="fas fa-clock mr-2"></i>
                                                <span id="preview-duration"></span>
                                            </div>
                                            <div class="text-sm text-black text-gray-700 flex items-center gap-2">
                                                <i class="fas fa-check-circle"></i>
                                                <span>Video successfully recognized</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- STEP 2: Lesson Context -->
                        <div class="mb-8 border-t border-teal-soft/10 pt-8">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-teal-soft to-blue-soft text-[#ffffff] flex items-center justify-center font-bold text-lg">2</div>
                                <h2 class="text-2xl font-bold text-black">Lesson Context</h2>
                            </div>
                            
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm text-black font-semibold text-gray-700 mb-3">
                                        Working Lesson Title
                                    </label>
                                    <input 
                                        type="text" 
                                        name="working_title" 
                                        placeholder="Sprint 8.0 – Session 1: Orientation"
                                        class="w-full bg-white border border-slate-200 rounded-xl px-4 py-3 text-sm text-black text-slate-900 placeholder:text-slate-400 focus:outline-none focus:border-teal-500 focus:ring-4 focus:ring-teal-500/10 transition-all"
                                        required
                                    >
                                </div>
                                
                                <div>
                                    <label class="block text-sm text-black font-semibold text-gray-700 mb-3">
                                        Optional: Notes or rough outline for AI
                                    </label>
                                    <textarea 
                                        name="rough_notes" 
                                        rows="6"
                                        placeholder="Drop session notes, bullets, workshop outline, or even messy copy here. The AI will use this to generate better descriptions and outcomes."
                                        class="w-full bg-[#ffffff]/60 border border-teal-soft/20 rounded-xl px-4 py-3 text-sm text-black focus:outline-none focus:border-teal-soft/50 focus:bg-[#ffffff]/80 resize-none transition-all"
                                    ></textarea>
                                    <p class="text-xs text-gray-700 mt-2">
                                        If you don't add anything, the AI still handles the description based on the video title — but notes improve accuracy.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- STEP 2.5: Lesson Content Blocks (Optional - for lessons without video) -->
                        <div class="mb-8 border-t border-teal-soft/10 pt-8">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-teal-soft to-blue-soft text-[#ffffff] flex items-center justify-center font-bold text-lg">2.5</div>
                                <h2 class="text-2xl font-bold text-black">Lesson Content <span class="text-sm font-normal text-gray-500">(Optional)</span></h2>
                            </div>
                            
                            <div class="space-y-4">
                                <p class="text-sm text-gray-600 mb-4">
                                    Add structured content blocks (headers, paragraphs, images) for lessons without videos. This content will be displayed to students.
                                </p>
                                
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex gap-2">
                                        <button type="button" id="add-paragraph-btn" class="px-3 py-2 bg-teal-soft/10 border border-teal-soft/30 rounded-lg text-xs font-medium hover:bg-teal-soft/20 transition-all text-black">
                                            <i class="fas fa-paragraph mr-1"></i> Add Paragraph
                                        </button>
                                        <button type="button" id="add-header-btn" class="px-3 py-2 bg-teal-soft/10 border border-teal-soft/30 rounded-lg text-xs font-medium hover:bg-teal-soft/20 transition-all text-black">
                                            <i class="fas fa-heading mr-1"></i> Add Header
                                        </button>
                                        <button type="button" id="add-image-btn" class="px-3 py-2 bg-teal-soft/10 border border-teal-soft/30 rounded-lg text-xs font-medium hover:bg-teal-soft/20 transition-all text-black">
                                            <i class="fas fa-image mr-1"></i> Add Image
                                        </button>
                                        <button type="button" id="add-list-btn" class="px-3 py-2 bg-teal-soft/10 border border-teal-soft/30 rounded-lg text-xs font-medium hover:bg-teal-soft/20 transition-all text-black">
                                            <i class="fas fa-list mr-1"></i> Add List
                                        </button>
                                    </div>
                                </div>
                                
                                <div id="content-blocks-container" class="space-y-4">
                                    <p class="text-gray-500 text-sm italic text-center py-4">No content blocks yet. Click the buttons above to add content.</p>
                                </div>
                                
                                <!-- Hidden input to store JSON data -->
                                <input type="hidden" name="content_blocks" id="content-blocks-json" value="">
                            </div>
                        </div>

                        <!-- Hidden transcription field -->
                        <input type="hidden" name="transcription" id="transcription-input">

                        <!-- STEP 3: AI Generation Button -->
                        <div class="border-t border-teal-soft/10 pt-8">
                            <button 
                                type="submit"
                                id="generate-btn"
                                class="w-full px-6 py-4 bg-gradient-to-r from-teal-soft to-blue-soft text-[#ffffff] rounded-xl font-bold text-lg hover:shadow-2xl hover:shadow-teal-soft/30 transition-all duration-300 transform hover:scale-[1.02] active:scale-[0.98] disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:scale-100"
                            >
                                <i class="fas fa-magic mr-2"></i>
                                Generate Lesson Description & Outputs
                            </button>
                            <p class="text-xs text-gray-700 mt-3 text-center">
                                The AI will generate: clean title, summary, full description, outcomes, and recommended coach actions.
                            </p>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- Right Column: Transcription Panel -->
            <div class="lg:col-span-1">
                <div class="bg-white border border-slate-200 rounded-2xl p-6 shadow-xl sticky top-24">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-lg font-bold flex items-center gap-2">
                            <i class="fas fa-file-alt text-black"></i>
                            Transcription
                        </h3>
                        <button id="copy-transcription" class="hidden text-xs text-black/70 hover:text-black transition-colors" title="Copy transcription">
                            <i class="fas fa-copy"></i>
                        </button>
                    </div>
                    
                    <!-- Transcription Status -->
                    <div id="transcription-status" class="mb-4">
                        <div id="status-pending" class="text-center py-8">
                            <i class="fas fa-file-video text-4xl text-gray-600 mb-3"></i>
                            <p class="text-sm text-black text-gray-700">Upload a video to generate transcription</p>
                        </div>
                        
                        <div id="status-processing" class="hidden text-center py-8">
                            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-teal-soft/10 mb-4">
                                <i class="fas fa-spinner fa-spin text-2xl text-black"></i>
                            </div>
                            <p class="text-sm text-black font-semibold text-gray-700 text-black mb-1">Generating transcription...</p>
                            <p class="text-xs text-gray-700">This may take a moment</p>
                        </div>
                        
                        <div id="status-error" class="hidden text-center py-6">
                            <div class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-red-500/10 mb-3">
                                <i class="fas fa-exclamation-triangle text-xl text-red-400"></i>
                            </div>
                            <p class="text-sm text-black text-red-400 mb-2" id="error-message">Transcription failed</p>
                            <button id="retry-transcription" class="px-4 py-2 bg-teal-soft/10 border border-teal-soft/30 rounded-lg text-xs text-black hover:bg-teal-soft/20 transition-colors">
                                <i class="fas fa-redo mr-1"></i> Retry Transcription
                            </button>
                        </div>
                    </div>
                    
                    <!-- Transcription Content -->
                    <div id="transcription-content" class="hidden">
                        <textarea 
                            id="transcription-textarea"
                            rows="20"
                            class="w-full bg-[#ffffff]/60 border border-teal-soft/20 rounded-xl px-4 py-3 text-sm text-black text-gray-700 focus:outline-none focus:border-teal-soft/50 focus:bg-[#ffffff]/80 resize-none transition-all font-mono leading-relaxed"
                            placeholder="Transcription will appear here..."
                        ></textarea>
                        
                        <!-- Action Buttons -->
                        <div class="flex gap-2 mt-4">
                            <button id="use-for-description" class="flex-1 px-3 py-2 bg-teal-soft/10 border border-teal-soft/30 rounded-lg text-xs text-black hover:bg-teal-soft/20 transition-colors">
                                <i class="fas fa-magic mr-1"></i> Use for Description
                            </button>
                            <button id="copy-transcription-btn" class="px-3 py-2 bg-teal-soft/10 border border-teal-soft/30 rounded-lg text-xs text-black hover:bg-teal-soft/20 transition-colors">
                                <i class="fas fa-copy"></i>
                            </button>
                        </div>
                        
                        <p class="text-xs text-gray-500 mt-3 text-center">
                            <i class="fas fa-edit mr-1"></i> You can edit the transcription directly
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!-- Global Lesson Modal (reusable) -->
<div 
    id="global-lesson-modal" 
    class="fixed inset-0 z-50 hidden items-center justify-center bg-black/60 backdrop-blur-sm"
>
    <div class="bg-[#ffffff] border border-teal-soft/30 rounded-2xl shadow-2xl max-w-md w-full mx-4 p-6">
        <div class="flex items-start gap-3 mb-4">
            <div class="w-9 h-9 rounded-full bg-red-500/10 border border-red-500/40 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-exclamation-triangle text-red-400"></i>
            </div>
            <div>
                <h3 class="text-lg font-semibold text-slate-900 mb-1" id="global-lesson-modal-title">Heads up</h3>
                <p id="global-lesson-modal-message" class="text-sm text-black text-gray-700 leading-relaxed"></p>
            </div>
        </div>
        <div class="flex justify-end">
            <button 
                type="button"
                id="global-lesson-modal-close"
                class="px-5 py-2 rounded-full bg-gradient-to-r from-teal-soft to-blue-soft text-[#ffffff] font-semibold text-gray-700 text-sm text-black hover:from-teal-soft/90 hover:to-blue-soft/90 focus:outline-none focus:ring-2 focus:ring-teal-soft/60"
            >
                Got it
            </button>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    // Global modal helpers (shared on this page)
    const globalLessonModal = document.getElementById('global-lesson-modal');
    const globalLessonModalTitle = document.getElementById('global-lesson-modal-title');
    const globalLessonModalMessage = document.getElementById('global-lesson-modal-message');
    const globalLessonModalClose = document.getElementById('global-lesson-modal-close');

    function showGlobalLessonModal(message, title) {
        if (!globalLessonModal || !globalLessonModalMessage) {
            return;
        }
        globalLessonModalTitle.textContent = title || 'Heads up';
        globalLessonModalMessage.textContent = message;
        globalLessonModal.classList.remove('hidden');
        globalLessonModal.classList.add('flex');
    }

    if (globalLessonModalClose && globalLessonModal) {
        globalLessonModalClose.addEventListener('click', () => {
            globalLessonModal.classList.add('hidden');
            globalLessonModal.classList.remove('flex');
        });

        globalLessonModal.addEventListener('click', (e) => {
            if (e.target === globalLessonModal) {
                globalLessonModal.classList.add('hidden');
                globalLessonModal.classList.remove('flex');
            }
        });
    }

    const videoFileInput = document.getElementById('video-file');
    const vimeoUrlInput = document.getElementById('vimeo-url');
    const videoPreview = document.getElementById('video-preview');
    const skipVideoBtn = document.getElementById('skip-video-btn');
    const generateBtn = document.getElementById('generate-btn');
    const transcriptionInput = document.getElementById('transcription-input');
    const transcriptionTextarea = document.getElementById('transcription-textarea');
    const transcriptionContent = document.getElementById('transcription-content');
    const uploadProgress = document.getElementById('upload-progress');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    
    // Status elements
    const statusPending = document.getElementById('status-pending');
    const statusProcessing = document.getElementById('status-processing');
    const statusError = document.getElementById('status-error');
    const errorMessage = document.getElementById('error-message');
    const retryBtn = document.getElementById('retry-transcription');
    const copyTranscriptionBtn = document.getElementById('copy-transcription');
    const copyTranscriptionBtn2 = document.getElementById('copy-transcription-btn');
    const useForDescriptionBtn = document.getElementById('use-for-description');
    
    let vimeoVerified = false;
    let transcriptionData = '';
    let currentVideoFile = null;
    
    // Show status
    function showStatus(status) {
        statusPending.classList.add('hidden');
        statusProcessing.classList.add('hidden');
        statusError.classList.add('hidden');
        transcriptionContent.classList.add('hidden');
        
        if (status === 'pending') {
            statusPending.classList.remove('hidden');
        } else if (status === 'processing') {
            statusProcessing.classList.remove('hidden');
        } else if (status === 'error') {
            statusError.classList.remove('hidden');
        } else if (status === 'completed') {
            transcriptionContent.classList.remove('hidden');
            copyTranscriptionBtn.classList.remove('hidden');
        }
    }
    
    // Handle video file upload
    videoFileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        
        if (!file.name.toLowerCase().endsWith('.mp4')) {
            showGlobalLessonModal('Please upload an MP4 video file', 'Invalid file type');
            this.value = '';
            return;
        }
        
        currentVideoFile = file;
        showStatus('processing');
        uploadProgress.classList.remove('hidden');
        
        // Upload and transcribe
        const formData = new FormData();
        formData.append('video_file', file);
        formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
        
        // Simulate upload progress
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 10;
            if (progress <= 90) {
                progressBar.style.width = progress + '%';
                progressText.textContent = progress + '%';
            }
        }, 200);
        
        fetch('{% url "upload_video_transcribe" %}', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            progressText.textContent = '100%';
            
            setTimeout(() => {
                uploadProgress.classList.add('hidden');
            }, 500);
            
            if (data.success) {
                transcriptionData = data.transcription;
                transcriptionTextarea.value = data.transcription;
                transcriptionInput.value = data.transcription;
                showStatus('completed');
                generateBtn.disabled = false;
            } else {
                errorMessage.textContent = data.error || 'Transcription failed';
                showStatus('error');
            }
        })
        .catch(error => {
            clearInterval(progressInterval);
            uploadProgress.classList.add('hidden');
            errorMessage.textContent = 'Error: ' + error.message;
            showStatus('error');
        });
    });
    
    // Retry transcription
    retryBtn.addEventListener('click', function() {
        if (currentVideoFile) {
            videoFileInput.dispatchEvent(new Event('change'));
        }
    });
    
    // Copy transcription
    copyTranscriptionBtn.addEventListener('click', copyTranscription);
    copyTranscriptionBtn2.addEventListener('click', copyTranscription);
    
    function copyTranscription() {
        transcriptionTextarea.select();
        document.execCommand('copy');
        
        // Show feedback
        const originalText = copyTranscriptionBtn2.innerHTML;
        copyTranscriptionBtn2.innerHTML = '<i class="fas fa-check"></i>';
        copyTranscriptionBtn2.classList.add('bg-green-500/20', 'border-green-500/30', 'text-gray-700');
        setTimeout(() => {
            copyTranscriptionBtn2.innerHTML = originalText;
            copyTranscriptionBtn2.classList.remove('bg-green-500/20', 'border-green-500/30', 'text-gray-700');
        }, 2000);
    }
    
    // Use transcription for description
    useForDescriptionBtn.addEventListener('click', function() {
        const roughNotes = document.querySelector('textarea[name="rough_notes"]');
        roughNotes.value = transcriptionTextarea.value;
        roughNotes.focus();
    });
    
    // Update transcription when edited
    transcriptionTextarea.addEventListener('input', function() {
        transcriptionData = this.value;
        transcriptionInput.value = this.value;
    });
    
    // Handle skip video button - use event delegation to ensure it works
    function handleSkipVideo(e) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('Skip video button clicked');
        
        // Get elements fresh in case they weren't available before
        const videoFileInputEl = document.getElementById('video-file');
        const vimeoUrlInputEl = document.getElementById('vimeo-url');
        const videoPreviewEl = document.getElementById('video-preview');
        const generateBtnEl = document.getElementById('generate-btn');
        
        // Hide video input sections
        const videoUploadSection = document.getElementById('video-upload-section');
        const videoDivider = document.getElementById('video-divider');
        const vimeoInputSection = document.getElementById('vimeo-input-section');
        const skipVideoSection = document.getElementById('skip-video-section');
        const videoSkippedMessage = document.getElementById('video-skipped-message');
        
        // Hide all video input elements
        if (videoUploadSection) videoUploadSection.style.display = 'none';
        if (videoDivider) videoDivider.style.display = 'none';
        if (vimeoInputSection) vimeoInputSection.style.display = 'none';
        if (skipVideoSection) skipVideoSection.style.display = 'none';
        
        // Show confirmation message
        if (videoSkippedMessage) {
            videoSkippedMessage.classList.remove('hidden');
        }
        
        // Clear video file input
        if (videoFileInputEl) {
            videoFileInputEl.value = '';
        }
        // Clear Vimeo URL
        if (vimeoUrlInputEl) {
            vimeoUrlInputEl.value = '';
        }
        // Hide video preview
        if (videoPreviewEl) {
            videoPreviewEl.classList.add('hidden');
        }
        // Reset transcription status
        if (typeof showStatus === 'function') {
            showStatus('pending');
        }
        // Clear any video-related data
        if (typeof currentVideoFile !== 'undefined') {
            currentVideoFile = null;
        }
        if (typeof vimeoVerified !== 'undefined') {
            vimeoVerified = false;
        }
        if (typeof transcriptionData !== 'undefined') {
            transcriptionData = '';
        }
        // Enable generate button (form can be submitted without video)
        if (generateBtnEl) {
            generateBtnEl.disabled = false;
        }
    }
    
    // Try to attach to button directly
    if (skipVideoBtn) {
        skipVideoBtn.addEventListener('click', handleSkipVideo);
    }
    
    // Also use event delegation as backup
    document.addEventListener('click', function(e) {
        if (e.target && (e.target.id === 'skip-video-btn' || e.target.closest('#skip-video-btn'))) {
            handleSkipVideo(e);
        }
    });
    
    // Content Blocks Management
    const contentBlocksContainer = document.getElementById('content-blocks-container');
    const contentBlocksJson = document.getElementById('content-blocks-json');
    const addParagraphBtn = document.getElementById('add-paragraph-btn');
    const addHeaderBtn = document.getElementById('add-header-btn');
    const addImageBtn = document.getElementById('add-image-btn');
    const addListBtn = document.getElementById('add-list-btn');
    
    let blockIndex = 0;
    
    function createContentBlock(type, data = {}) {
        const blockDiv = document.createElement('div');
        blockDiv.className = 'content-block-item border border-teal-soft/20 rounded-lg p-4 bg-[#ffffff]/40';
        blockDiv.dataset.blockIndex = blockIndex++;
        
        let contentHTML = '';
        
        if (type === 'paragraph') {
            contentHTML = `
                <textarea class="block-input w-full bg-[#ffffff]/60 border border-teal-soft/20 rounded-lg px-3 py-2 text-sm text-black resize-none" rows="3" data-field="text" placeholder="Enter paragraph text...">${data.text || ''}</textarea>
            `;
        } else if (type === 'header') {
            contentHTML = `
                <div class="flex gap-2">
                    <select class="block-input bg-[#ffffff]/60 border border-teal-soft/20 rounded-lg px-3 py-2 text-sm text-black" data-field="level">
                        <option value="1" ${data.level == 1 ? 'selected' : ''}>H1</option>
                        <option value="2" ${data.level == 2 ? 'selected' : 'selected'}>H2</option>
                        <option value="3" ${data.level == 3 ? 'selected' : ''}>H3</option>
                        <option value="4" ${data.level == 4 ? 'selected' : ''}>H4</option>
                    </select>
                    <input type="text" class="block-input flex-1 bg-[#ffffff]/60 border border-teal-soft/20 rounded-lg px-3 py-2 text-sm text-black" data-field="text" value="${data.text || ''}" placeholder="Enter header text...">
                </div>
            `;
        } else if (type === 'image') {
            contentHTML = `
                <div class="space-y-2">
                    <input type="url" class="block-input w-full bg-[#ffffff]/60 border border-teal-soft/20 rounded-lg px-3 py-2 text-sm text-black" data-field="url" value="${data.url || ''}" placeholder="Enter image URL...">
                    <input type="text" class="block-input w-full bg-[#ffffff]/60 border border-teal-soft/20 rounded-lg px-3 py-2 text-sm text-black" data-field="caption" value="${data.caption || ''}" placeholder="Enter image caption (optional)...">
                    ${data.url ? `<div class="mt-2"><img src="${data.url}" alt="${data.caption || 'Image'}" class="max-w-xs rounded-lg border border-teal-soft/20"></div>` : ''}
                </div>
            `;
        } else if (type === 'list') {
            const items = data.items ? (Array.isArray(data.items) ? data.items.join('\n') : data.items) : '';
            contentHTML = `
                <div class="space-y-2">
                    <select class="block-input mb-2 bg-[#ffffff]/60 border border-teal-soft/20 rounded-lg px-3 py-2 text-sm text-black" data-field="style">
                        <option value="unordered" ${data.style !== 'ordered' ? 'selected' : ''}>Unordered List</option>
                        <option value="ordered" ${data.style === 'ordered' ? 'selected' : ''}>Ordered List</option>
                    </select>
                    <textarea class="block-input w-full bg-[#ffffff]/60 border border-teal-soft/20 rounded-lg px-3 py-2 text-sm text-black resize-none" rows="4" data-field="items" placeholder="Enter list items, one per line...">${items}</textarea>
                </div>
            `;
        }
        
        blockDiv.innerHTML = `
            <div class="flex items-start justify-between mb-2">
                <div class="flex items-center gap-2">
                    <span class="text-xs font-semibold text-teal-soft bg-teal-soft/10 px-2 py-1 rounded">${type.charAt(0).toUpperCase() + type.slice(1)}</span>
                    <button type="button" class="move-block-up text-xs text-gray-600 hover:text-teal-soft" title="Move up">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                    <button type="button" class="move-block-down text-xs text-gray-600 hover:text-teal-soft" title="Move down">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                </div>
                <button type="button" class="delete-block text-xs text-red-600 hover:text-red-700" title="Delete block">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div class="block-content">${contentHTML}</div>
        `;
        
        // Handle image URL preview
        if (type === 'image') {
            const urlInput = blockDiv.querySelector('input[data-field="url"]');
            urlInput.addEventListener('input', function() {
                const img = blockDiv.querySelector('img');
                const imgContainer = blockDiv.querySelector('.mt-2');
                if (this.value && this.value.trim()) {
                    if (!img) {
                        const newImgContainer = document.createElement('div');
                        newImgContainer.className = 'mt-2';
                        newImgContainer.innerHTML = `<img src="${this.value}" alt="Preview" class="max-w-xs rounded-lg border border-teal-soft/20">`;
                        blockDiv.querySelector('.block-content').appendChild(newImgContainer);
                    } else {
                        img.src = this.value;
                    }
                } else if (imgContainer) {
                    imgContainer.remove();
                }
            });
        }
        
        return blockDiv;
    }
    
    function serializeContentBlocks() {
        const blocks = contentBlocksContainer.querySelectorAll('.content-block-item');
        const blocksArray = [];
        
        blocks.forEach(block => {
            const type = block.querySelector('.text-teal-soft').textContent.toLowerCase();
            const data = {};
            
            block.querySelectorAll('.block-input').forEach(input => {
                const field = input.dataset.field;
                if (field === 'items') {
                    data[field] = input.value.split('\n').filter(item => item.trim());
                } else {
                    data[field] = input.value;
                }
            });
            
            blocksArray.push({
                type: type,
                data: data
            });
        });
        
        if (contentBlocksJson) {
            contentBlocksJson.value = JSON.stringify(blocksArray);
        }
    }
    
    function updateBlockIndices() {
        const blocks = contentBlocksContainer.querySelectorAll('.content-block-item');
        blocks.forEach((block, index) => {
            block.dataset.blockIndex = index;
        });
        serializeContentBlocks();
    }
    
    // Add block buttons
    if (addParagraphBtn) {
        addParagraphBtn.addEventListener('click', function() {
            const emptyMsg = contentBlocksContainer.querySelector('p.text-gray-500');
            if (emptyMsg) emptyMsg.remove();
            
            const block = createContentBlock('paragraph', {});
            contentBlocksContainer.appendChild(block);
            updateBlockIndices();
        });
    }
    
    if (addHeaderBtn) {
        addHeaderBtn.addEventListener('click', function() {
            const emptyMsg = contentBlocksContainer.querySelector('p.text-gray-500');
            if (emptyMsg) emptyMsg.remove();
            
            const block = createContentBlock('header', { level: 2 });
            contentBlocksContainer.appendChild(block);
            updateBlockIndices();
        });
    }
    
    if (addImageBtn) {
        addImageBtn.addEventListener('click', function() {
            const emptyMsg = contentBlocksContainer.querySelector('p.text-gray-500');
            if (emptyMsg) emptyMsg.remove();
            
            const block = createContentBlock('image', {});
            contentBlocksContainer.appendChild(block);
            updateBlockIndices();
        });
    }
    
    if (addListBtn) {
        addListBtn.addEventListener('click', function() {
            const emptyMsg = contentBlocksContainer.querySelector('p.text-gray-500');
            if (emptyMsg) emptyMsg.remove();
            
            const block = createContentBlock('list', { style: 'unordered' });
            contentBlocksContainer.appendChild(block);
            updateBlockIndices();
        });
    }
    
    // Handle block actions
    if (contentBlocksContainer) {
        contentBlocksContainer.addEventListener('click', function(e) {
            // Delete block
            if (e.target.closest('.delete-block')) {
                if (confirm('Delete this content block?')) {
                    e.target.closest('.content-block-item').remove();
                    if (contentBlocksContainer.children.length === 0) {
                        contentBlocksContainer.innerHTML = '<p class="text-gray-500 text-sm italic text-center py-4">No content blocks yet. Click the buttons above to add content.</p>';
                    }
                    updateBlockIndices();
                }
            }
            
            // Move up
            if (e.target.closest('.move-block-up')) {
                const block = e.target.closest('.content-block-item');
                const prev = block.previousElementSibling;
                if (prev) {
                    block.parentNode.insertBefore(block, prev);
                    updateBlockIndices();
                }
            }
            
            // Move down
            if (e.target.closest('.move-block-down')) {
                const block = e.target.closest('.content-block-item');
                const next = block.nextElementSibling;
                if (next) {
                    block.parentNode.insertBefore(next, block);
                    updateBlockIndices();
                }
            }
        });
        
        // Serialize on input changes
        contentBlocksContainer.addEventListener('input', function() {
            serializeContentBlocks();
        });
    }
    
    // Verify Vimeo URL on blur
    vimeoUrlInput.addEventListener('blur', function() {
        const url = this.value.trim();
        if (!url) {
            videoPreview.classList.add('hidden');
            if (!transcriptionData) {
                generateBtn.disabled = true;
            }
            vimeoVerified = false;
            return;
        }
        
        // Verify URL
        fetch('{% url "verify_vimeo_url" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: `vimeo_url=${encodeURIComponent(url)}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('preview-thumbnail').src = data.thumbnail;
                document.getElementById('preview-title').textContent = data.title || 'Video recognized';
                document.getElementById('preview-duration').textContent = `Duration: ${data.duration_formatted}`;
                videoPreview.classList.remove('hidden');
                generateBtn.disabled = false;
                vimeoVerified = true;
            } else {
                videoPreview.classList.add('hidden');
                if (!transcriptionData) {
                    generateBtn.disabled = true;
                }
                vimeoVerified = false;
                showGlobalLessonModal('Could not verify Vimeo URL: ' + (data.error || 'Unknown error'), 'Vimeo error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            videoPreview.classList.add('hidden');
            if (!transcriptionData) {
                generateBtn.disabled = true;
            }
            vimeoVerified = false;
        });
    });
    
    // Enable generate button if either vimeo or transcription is available
    function checkFormReady() {
        if (vimeoVerified || transcriptionData) {
            if (generateBtn) {
                generateBtn.disabled = false;
            }
        }
    }
    
</script>
{% endblock %}
