{% extends 'base.html' %}
{% load static %}

{% block title %}Courses — Fluentory{% endblock %}

{% block content %}

<!-- PAGE SHELL -->
<div class="min-h-screen bg-gradient-to-b from-slate-50 via-white to-slate-50">
  <div class="mx-auto max-w-7xl px-6 py-10 md:py-12">

    <style>
      /* Hide scrollbars (carousel) */
      .hide-scroll::-webkit-scrollbar { display: none; }
      .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }
    </style>

    <!-- PAGE HEADER -->
    <section class="mb-8 md:mb-12">
      <div class="flex flex-col gap-6 lg:flex-row lg:items-end lg:justify-between">

        <div class="min-w-0 max-w-3xl">
          <p class="text-[11px] font-semibold tracking-[0.34em] uppercase text-slate-500">Courses</p>
          <h1 class="mt-3 text-3xl sm:text-4xl md:text-5xl font-extrabold tracking-tight text-ink-deep">
            Choose what you want to master next
          </h1>
          <p class="mt-3 text-sm text-black sm:text-base text-slate-600">
            Self-paced learning, downloadable resources, and progress tracking — all in one hub.
          </p>
        </div>

        <!-- Controls -->
        <div class="flex flex-col sm:flex-row gap-3 w-full lg:w-auto">
          <!-- Dropdown -->
          <div class="relative w-full sm:w-56">
            <i class="fas fa-filter absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
            <select
              class="w-full appearance-none rounded-2xl border border-slate-200 bg-white px-4 py-2.5 pl-9 pr-10 text-sm text-black font-semibold text-slate-700 shadow-sm transition
                     hover:border-slate-300 focus:outline-none focus:ring-4 focus:ring-teal-soft/15">
              <option>All categories</option>
              <option>Natural health</option>
              <option>Personal development</option>
              <option>Energy therapies</option>
            </select>
            <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i>
          </div>

          <!-- Search -->
          <div class="relative w-full sm:w-72 lg:w-64">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
            <input type="text"
                   placeholder="Search courses…"
                   class="w-full rounded-2xl border border-slate-200 bg-white px-4 py-2.5 pl-9 pr-4 text-sm text-black text-slate-800 placeholder:text-slate-400 shadow-sm transition
                          hover:border-slate-300 focus:outline-none focus:ring-4 focus:ring-teal-soft/15">
          </div>
        </div>

      </div>
    </section>

    <!-- CONTINUE LEARNING -->
    {% if request.user.is_authenticated and in_progress_courses %}
    <section class="mb-10 md:mb-14">
      <div class="flex items-center justify-between gap-4 mb-5">
        <div>
          <h2 class="text-2xl md:text-3xl font-extrabold tracking-tight text-ink-deep">Continue learning</h2>
          <p class="mt-1 text-sm text-black text-slate-600">Jump back in where you left off.</p>
        </div>

        <div class="hidden md:flex items-center gap-2 text-[11px] font-semibold tracking-[0.22em] uppercase text-slate-400">
          <span class="inline-flex items-center gap-2">
            <span class="h-1.5 w-1.5 rounded-full bg-teal-soft"></span> In progress
          </span>
        </div>
      </div>

      <div class="relative">
        <!-- subtle rail fade edges -->
        <div class="pointer-events-none absolute inset-y-0 left-0 w-10 bg-gradient-to-r from-white via-white/70 to-transparent z-10"></div>
        <div class="pointer-events-none absolute inset-y-0 right-0 w-10 bg-gradient-to-l from-white via-white/70 to-transparent z-10"></div>

        <!-- SCROLLER -->
        <div class="hide-scroll flex gap-4 overflow-x-auto pb-3 snap-x snap-mandatory">
          {% for data in in_progress_courses %}
            {% with course=data.course %}
            <article class="snap-start w-[320px] sm:w-[380px] lg:w-[420px] shrink-0 overflow-hidden rounded-3xl border border-slate-200 bg-white shadow-sm transition flex flex-col
                            hover:-translate-y-0.5 hover:border-slate-300 hover:shadow-md
                            {% if data.is_favorited %} ring-2 ring-amber-200 {% endif %}">
              <!-- Thumb -->
              <div class="relative h-44 flex-shrink-0">
                {% if course.thumbnail %}
                  <img src="{{ course.thumbnail.url }}" alt="{{ course.name }}" class="h-full w-full object-cover">
                {% else %}
                  <div class="h-full w-full bg-gradient-to-br from-teal-soft/15 to-blue-soft/15 flex items-center justify-center">
                    <i class="fas fa-book-open text-3xl text-blue-soft/70"></i>
                  </div>
                {% endif %}
                <div class="absolute inset-0 bg-gradient-to-t from-black/35 via-black/5 to-transparent"></div>

                <div class="absolute left-4 top-4 inline-flex items-center gap-2 rounded-full bg-white/90 px-3 py-1 text-[11px] font-extrabold text-slate-700">
                  <i class="fas fa-play text-black text-[10px]"></i> Continue
                </div>

                {% if course.special_tag %}
                <div class="absolute right-4 top-4 inline-flex items-center rounded-full bg-coral-cta px-3 py-1 text-[11px] font-extrabold text-white shadow-lg shadow-coral-cta/20">
                  {{ course.special_tag }}
                </div>
                {% endif %}
              </div>

              <!-- Body -->
              <div class="p-5 flex flex-col flex-grow">
                <div class="flex items-start justify-between gap-3">
                  <h3 class="text-lg font-extrabold text-ink-deep leading-snug line-clamp-2">
                    {{ course.name }}
                  </h3>

                  {% if request.user.is_authenticated %}
                  <button onclick="toggleFavorite({{ course.id }}, this)"
                          class="favorite-btn inline-flex h-10 w-10 items-center justify-center rounded-full border border-slate-200 bg-white shadow-sm transition
                                 hover:border-slate-300 hover:scale-[1.02]
                                 {% if data.is_favorited %} text-amber-600 {% else %} text-slate-400 hover:text-amber-600 {% endif %}"
                          data-course-id="{{ course.id }}"
                          data-is-favorited="{{ data.is_favorited|yesno:'true,false' }}"
                          aria-label="Toggle favorite">
                    <i class="fa-heart {% if data.is_favorited %}fas{% else %}far{% endif %}"></i>
                  </button>
                  {% endif %}
                </div>

                <p class="mt-2 text-sm text-black text-slate-600 line-clamp-2">
                  {{ course.short_description }}
                </p>

                {% if data.progress_percentage %}
                <div class="mt-4">
                  <div class="flex items-center justify-between text-[12px] text-slate-500">
                    <span>Progress</span>
                    <span class="font-semibold text-blue-soft">{{ data.progress_percentage }}%</span>
                  </div>
                  <div class="mt-2 h-2.5 w-full overflow-hidden rounded-full bg-slate-200">
                    <div class="h-full rounded-full bg-gradient-to-r from-teal-soft to-blue-soft transition-all duration-500"
                         style="width: {{ data.progress_percentage }}%"></div>
                  </div>
                </div>
                {% endif %}

                <div class="mt-4 flex items-center justify-between text-sm text-black">
                  <span class="text-slate-500">
                    <i class="fas fa-layer-group mr-2 text-slate-400"></i>{{ course.get_lesson_count }} lessons
                  </span>

                  <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-700">
                    {% if course.status %}{{ course.get_status_display }}{% else %}Active{% endif %}
                  </span>
                </div>

                <div class="mt-auto pt-5 flex items-center gap-3">
                  {% if course.status == 'active' %}
                    {% if data.progress_percentage and data.progress_percentage >= 100 %}
                      {# Course completed - show certificate/view details button only #}
                      <a href="{% url 'student_course_progress' course.slug %}"
                         class="flex-1 inline-flex items-center justify-center rounded-2xl bg-gradient-to-r from-yellow-500 to-yellow-600 px-4 py-2.5 text-sm text-black font-extrabold text-white shadow-lg shadow-yellow-500/20 transition
                                hover:-translate-y-0.5 hover:shadow-xl hover:shadow-yellow-500/25">
                        <i class="fas fa-certificate mr-2 text-xs"></i>
                        View Certificate
                      </a>
                    {% else %}
                      {# Course in progress - show continue and progress buttons #}
                      {% if course.lessons.first %}
                        <a href="{% url 'lesson_detail' course.slug course.lessons.first.slug %}"
                           class="flex-1 inline-flex items-center justify-center rounded-2xl bg-coral-cta px-4 py-2.5 text-sm text-black font-extrabold text-white shadow-lg shadow-coral-cta/20 transition
                                  hover:-translate-y-0.5 hover:shadow-xl hover:shadow-coral-cta/25">
                          Continue
                          <i class="fas fa-arrow-right ml-2 text-xs"></i>
                        </a>
                      {% endif %}
                      <a href="{% url 'student_course_progress' course.slug %}"
                         class="inline-flex items-center justify-center rounded-2xl border border-slate-200 bg-white px-4 py-2.5 text-sm text-black font-semibold text-ink-deep shadow-sm transition
                                hover:border-slate-300 hover:shadow-md">
                        Progress
                      </a>
                    {% endif %}
                  {% else %}
                    <button disabled class="flex-1 rounded-2xl bg-slate-200 px-4 py-2.5 text-sm text-black font-extrabold text-slate-500 cursor-not-allowed">
                      Locked
                    </button>
                  {% endif %}
                </div>
              </div>
            </article>
            {% endwith %}
          {% endfor %}
        </div>
      </div>
    </section>
    {% endif %}

    <!-- ALL COURSES -->
    <section class="space-y-5">
      <div class="flex items-end justify-between gap-4">
        <div>
          <h2 class="text-2xl md:text-3xl font-extrabold tracking-tight text-ink-deep">
            {% if request.user.is_authenticated %}Explore more{% else %}Explore courses{% endif %}
          </h2>
          <p class="mt-1 text-sm text-black text-slate-600">
            Browse the full catalog. Save favorites for later.
          </p>
        </div>

        <div class="hidden md:flex items-center gap-2 text-[11px] font-semibold tracking-[0.22em] uppercase text-slate-400">
          <i class="fas fa-heart text-amber-600"></i> Favorites
        </div>
      </div>

      {% if request.user.is_authenticated %}
        {% if not_started_courses %}
          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
            {% for data in not_started_courses %}
              {% with course=data.course %}
              <article class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm transition flex flex-col
                              hover:-translate-y-0.5 hover:border-slate-300 hover:shadow-md
                              {% if data.is_favorited %} ring-2 ring-amber-200 {% endif %}">
                <div class="flex items-start justify-between gap-3">
                  <h3 class="text-lg font-extrabold text-ink-deep leading-snug line-clamp-2">
                    {{ course.name }}
                  </h3>

                  <button onclick="toggleFavorite({{ course.id }}, this)"
                          class="favorite-btn inline-flex h-10 w-10 items-center justify-center rounded-full border border-slate-200 bg-white shadow-sm transition
                                 hover:border-slate-300 hover:scale-[1.02]
                                 {% if data.is_favorited %} text-amber-600 {% else %} text-slate-400 hover:text-amber-600 {% endif %}"
                          data-course-id="{{ course.id }}"
                          data-is-favorited="{{ data.is_favorited|yesno:'true,false' }}"
                          aria-label="Toggle favorite">
                    <i class="fa-heart {% if data.is_favorited %}fas{% else %}far{% endif %}"></i>
                  </button>
                </div>

                <p class="mt-2 text-sm text-black text-slate-600 line-clamp-2">{{ course.short_description }}</p>

                <div class="mt-4 rounded-2xl overflow-hidden border border-slate-200 bg-white">
                  {% if course.thumbnail %}
                    <img src="{{ course.thumbnail.url }}" alt="{{ course.name }}" class="h-40 w-full object-cover">
                  {% else %}
                    <div class="h-40 w-full bg-gradient-to-br from-teal-soft/15 to-blue-soft/15 flex items-center justify-center">
                      <i class="fas fa-leaf text-3xl text-black/70"></i>
                    </div>
                  {% endif %}
                </div>

                <div class="mt-4 flex flex-wrap gap-2">
                  {% if course.is_accredible_certified %}
                  <span class="inline-flex items-center gap-2 rounded-full border border-blue-soft/20 bg-blue-soft/10 px-3 py-1 text-xs font-semibold text-blue-soft">
                    <i class="fas fa-certificate"></i> Certified
                  </span>
                  {% endif %}
                  <span class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold text-slate-700">
                    <i class="fas fa-layer-group text-slate-400"></i> {{ course.get_lesson_count }} lessons
                  </span>
                </div>

                <div class="mt-auto pt-5">
                  {% if course.status == 'active' %}
                    {% if data.progress_percentage and data.progress_percentage >= 100 %}
                      {# Course completed - show certificate button only #}
                      <a href="{% url 'student_course_progress' course.slug %}"
                         class="w-full inline-flex items-center justify-center rounded-2xl bg-gradient-to-r from-yellow-500 to-yellow-600 px-4 py-2.5 text-sm text-black font-extrabold text-white shadow-lg shadow-yellow-500/20 transition
                                hover:-translate-y-0.5 hover:shadow-xl hover:shadow-yellow-500/25">
                        <i class="fas fa-certificate mr-2 text-xs"></i>
                        View Certificate
                      </a>
                    {% elif course.lessons.first %}
                      {# Course not started or in progress #}
                      <a href="{% url 'lesson_detail' course.slug course.lessons.first.slug %}"
                         class="w-full inline-flex items-center justify-center rounded-2xl bg-coral-cta px-4 py-2.5 text-sm text-black font-extrabold text-white shadow-lg shadow-coral-cta/20 transition
                                hover:-translate-y-0.5 hover:shadow-xl hover:shadow-coral-cta/25">
                        {% if data.progress_percentage and data.progress_percentage > 0 %}
                          Continue
                        {% else %}
                          Start course
                        {% endif %}
                        <i class="fas fa-arrow-right ml-2 text-xs"></i>
                      </a>
                    {% else %}
                      <a href="{% url 'student_course_progress' course.slug %}"
                         class="w-full inline-flex items-center justify-center rounded-2xl border border-slate-200 bg-white px-4 py-2.5 text-sm text-black font-semibold text-ink-deep shadow-sm transition
                                hover:border-slate-300 hover:shadow-md">
                        View details
                      </a>
                    {% endif %}
                  {% else %}
                    <button disabled class="w-full rounded-2xl bg-slate-200 px-4 py-2.5 text-sm text-black font-extrabold text-slate-500 cursor-not-allowed">
                      Locked
                    </button>
                  {% endif %}
                </div>
              </article>
              {% endwith %}
            {% endfor %}
          </div>
        {% else %}
          <div class="rounded-3xl border border-slate-200 bg-white p-12 text-center shadow-sm">
            <div class="mx-auto flex h-16 w-16 items-center justify-center rounded-3xl bg-success-soft/10">
              <i class="fas fa-check-circle text-2xl text-success-soft"></i>
            </div>
            <h3 class="mt-5 text-xl font-extrabold text-ink-deep">You’re on track</h3>
            <p class="mt-2 text-sm text-black text-slate-600">All available courses are currently in progress. Great work.</p>
          </div>
        {% endif %}
      {% else %}
        {% if courses_data %}
          <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-5">
            {% for data in courses_data %}
              {% with course=data.course %}
              <article class="rounded-3xl border border-slate-200 bg-white p-6 shadow-sm transition hover:-translate-y-0.5 hover:border-slate-300 hover:shadow-md flex flex-col">
                <h3 class="text-lg font-extrabold text-ink-deep leading-snug line-clamp-2">{{ course.name }}</h3>
                <p class="mt-2 text-sm text-black text-slate-600 line-clamp-2">{{ course.short_description }}</p>

                <div class="mt-4 rounded-2xl overflow-hidden border border-slate-200 bg-white">
                  {% if course.thumbnail %}
                    <img src="{{ course.thumbnail.url }}" alt="{{ course.name }}" class="h-40 w-full object-cover">
                  {% else %}
                    <div class="h-40 w-full bg-gradient-to-br from-teal-soft/15 to-blue-soft/15 flex items-center justify-center">
                      <i class="fas fa-book-open text-3xl text-blue-soft/70"></i>
                    </div>
                  {% endif %}
                </div>

                <div class="mt-4 flex items-center justify-between text-sm text-black text-slate-600">
                  <span><i class="fas fa-layer-group mr-2 text-slate-400"></i>{{ course.get_lesson_count }} lessons</span>
                  <span class="text-[11px] font-semibold tracking-[0.18em] uppercase text-slate-400">
                    {{ course.get_status_display }}
                  </span>
                </div>

                <div class="mt-auto pt-5">
                  {% if course.status == 'active' %}
                    <a href="{% url 'course_detail' course.slug %}"
                       class="w-full inline-flex items-center justify-center rounded-2xl bg-coral-cta px-4 py-2.5 text-sm text-black font-extrabold text-white shadow-lg shadow-coral-cta/20 transition
                              hover:-translate-y-0.5 hover:shadow-xl hover:shadow-coral-cta/25">
                      View course
                      <i class="fas fa-arrow-right ml-2 text-xs"></i>
                    </a>
                  {% else %}
                    <button disabled class="w-full rounded-2xl bg-slate-200 px-4 py-2.5 text-sm text-black font-extrabold text-slate-500 cursor-not-allowed">
                      Locked
                    </button>
                  {% endif %}
                </div>
              </article>
              {% endwith %}
            {% endfor %}
          </div>
        {% else %}
          <div class="rounded-3xl border border-slate-200 bg-white p-12 text-center shadow-sm">
            <div class="mx-auto flex h-16 w-16 items-center justify-center rounded-3xl bg-blue-soft/10">
              <i class="fas fa-book-open text-2xl text-blue-soft"></i>
            </div>
            <h3 class="mt-5 text-xl font-extrabold text-ink-deep">No courses available yet</h3>
            <p class="mt-2 text-sm text-black text-slate-600">Please check back soon.</p>
          </div>
        {% endif %}
      {% endif %}
    </section>

    {% if request.user.is_authenticated %}
    <script>
    function toggleFavorite(courseId, buttonElement) {
      const icon = buttonElement.querySelector('i');
      const isCurrentlyFavorited = buttonElement.dataset.isFavorited === 'true';
      const card = buttonElement.closest('article');

      const originalClass = icon.className;
      icon.className = 'fas fa-spinner fa-spin text-amber-600';

      fetch(`/api/courses/${courseId}/favorite/`, {
        method: 'POST',
        headers: {
          'X-CSRFToken': getCookie('csrftoken'),
          'Content-Type': 'application/json',
        },
      })
      .then(r => r.json())
      .then(data => {
        if (data.success) {
          icon.className = data.is_favorited ? 'fas fa-heart' : 'far fa-heart';
          buttonElement.dataset.isFavorited = data.is_favorited.toString();

          if (data.is_favorited) {
            buttonElement.classList.remove('text-slate-400');
            buttonElement.classList.add('text-amber-600');
            if (card) card.classList.add('ring-2','ring-amber-200');
          } else {
            buttonElement.classList.remove('text-amber-600');
            buttonElement.classList.add('text-slate-400');
            if (card) card.classList.remove('ring-2','ring-amber-200');
          }
        } else {
          icon.className = originalClass;
          buttonElement.dataset.isFavorited = isCurrentlyFavorited.toString();
          alert('Error: ' + (data.message || 'Failed to update favorite'));
        }
      })
      .catch(() => {
        icon.className = originalClass;
        buttonElement.dataset.isFavorited = isCurrentlyFavorited.toString();
        alert('Error updating favorite. Please try again.');
      });
    }

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    </script>
    {% endif %}

  </div>
</div>

{% endblock %}
